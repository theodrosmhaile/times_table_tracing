---
title: "TT data analysis"
---

```{r}
library(skimr)
library(tidyverse)
```
### Description of data

### Columns to be used

### Things to do: 
  - prepare data for GraafTel algorithm
  - write out plan for analysis
  - 
```{r}
dat <- readRDS('./TafelTrainer pilot data/tt_responses_all_clean.rds')
dat <- dat %>% filter(level == 1)
dat <- dat %>% mutate(correct = as.numeric(correct))

dat <- dat %>%
  arrange(user_id, cue_text, session_id) %>%
  group_by(user_id, cue_text) %>%
  mutate(encounter_num = row_number()) %>%
  ungroup()
  
```
```{r}
# Function to get specific encounter based on encounter type
get_encounter <- function(data, encounter_type) {
  data %>%
    group_by(user_id, cue_text) %>%
    filter(
      case_when(
        encounter_type == "second" ~ encounter_num == 2,
        encounter_type == "middle" ~ encounter_num == ceiling(n() / 2),
        encounter_type == "last" ~ encounter_num == n()
      )
    ) %>%
    select(user_id, cue_text, correct) %>%
    ungroup()
}
second_encounter_data <- get_encounter(dat, "second")
middle_encounter_data <- get_encounter(dat, "middle")
last_encounter_data <- get_encounter(dat, "last")

# Save each dataset as CSV
write.table(second_encounter_data, "./graaftel_input_second.csv", row.names = FALSE, col.names = FALSE, sep = ",")
write.table(middle_encounter_data, "./graaftel_input_middle.csv", row.names = FALSE, col.names = FALSE, sep = ",")
write.table(last_encounter_data, "./graaftel_input_last.csv", row.names = FALSE, col.names = FALSE, sep = ",")
```
```{r}
View(dat)
```
```{r}
print(head(dat, 10))
```
```{r}
print(head(second_encounter_data, 10))
```
```{r}
print(head(middle_encounter_data, 10))
```
```{r}
print(head(last_encounter_data, 10))
```

```{r}
need=c(0:100) %>% 
  as.character()

dat %>% 
  select(given_response,cue_text) %>%
  
  unlist() %>% 
  as.numeric() %>% 
  as_tibble() %>% 
  filter(value<=100) %>% 
  #filter(given_response  %in%  need) %>% 
 # mutate(given_response=fct_reorder((given_response), need)) %>% 
  #count(given_response)
  
 ggplot(aes(x=value))+
  geom_histogram(stat = 'count')+
   theme(axis.text.x=element_text(angle = 90))
```

### Descriptive stats
This is just some playing around with visualizing the accuracy data. Some more clean up will be needed and plotting data at specific instances (second encounter, last encounter etc). The plots below show mean accuracy across all instances (which is something we want to separate out). 
Think about doing some boxplots to see how the data is distributed for accuracy and reaction time data. The descriptives can be used to answer questions like: 
 - which items were most difficult for students?
 - what other patterns are salient in behavior?
 - How many trials does it take students, on average, to learn the associations? You can show change (increase) in accuracy across sessions and/or change (decrease) in reaction time across sessions. 
 - Do you have other questions that come in mind for you about this dat

```{r}
dat4plot <- 
  dat %>% 
  select(given_response, cue_text, correct, level, fact_id) %>% 
  filter(given_response %in% need) %>% 
  filter(level==1) %>% 
  mutate(cue_text=fct_reorder(cue_text,fact_id)) %>% 
    group_by(cue_text) %>% 
  summarise(mean_acc = mean(correct),
            n=n(), 
            se = sd(correct)/sqrt(n)) %>% 
  mutate('tafel_column' = paste0("col",matrix(1:10,10,10) %>% 
                                   t() %>%  
                                   c()),
         'multiplicant' = rep(c(1:10), 10)
         ) %>% 
  mutate(cue_text=fct_reorder(cue_text,multiplicant)) 

dat4plot %>% 

  
  ggplot(aes(x=cue_text, y=mean_acc, ymax=mean_acc+se, ymin=mean_acc-se, fill=as.factor(multiplicant)))+
  geom_bar(stat = 'identity')+
  geom_errorbar()+
  theme(axis.text.x=element_text(angle = 90), 
        legend.position = 'top')

dat4plot %>% 
  ggplot(aes(x=tafel_column, y = multiplicant, fill=mean_acc, label=round(mean_acc, 2))) +
  geom_tile() +
  geom_text()+
  scale_fill_gradient2(limits=c(0.7,1),
                       midpoint = 0.85,
                          low='blue',
                        mid="red",
                           high = 'yellow',
                          guide='colorbar',
                          aesthetics = 'fill',
                          breaks= seq(0.7,1,by=.01)
                       )
  

```

